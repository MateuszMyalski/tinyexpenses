{% extends "index.html" %}
{% block content %}
<script>
    year_expenses = {}
</script>
<h1 class="page-title centered">Yearly view</h1>
<div class="huge-table-wrapper">
    <table class="expenses-view year">
        <thead>
            <tr>
                <th colspan="15" class="time-span-header">
                    <select id="year-select" onchange="location = this.value;">
                        {% for available_year in available_years %}
                        <option value="{{ url_for('main.expenses_view_year', year=available_year) }}" {% if
                            available_year|int==year|int %}selected{% endif %}>
                            {{ available_year }}
                        </option>
                        {% endfor %}
                    </select>
                </th>
            </tr>
            <tr>
                <th class="category-header">Category</th>
                <th class="category-type-header">Type</th>
                {% for i in range(12) %}
                <th class="month-header"><a
                        href="{{ url_for('main.expenses_view_month', year=year, month=(i + 1)) }}">{{
                        month_names[i]
                        }}</a></th>
                {% endfor %}
                <th class="total-header">Total</th>
            </tr>
        </thead>
        <tbody>
            {% for category_type, categories_by_type in expenses_monthly_totals_by_category_type.items() %}
            {% for category, totals in categories_by_type.items() %}
            <tr class="category-row {{ category_type.value }}">
                <td class="category-cell">{{ category }}</td>
                <td class="category-type-cell">{{ category_type.value[0] }}</td>
                {% for value in totals %}
                <td class="amount-cell">
                    {% if category_type != CategoryType.INCOME %}
                    {{ -value | round(2) | format_number }}
                    {% else %}
                    {{ value | round(2) | format_number }}
                    {% endif %}
                    {{ currency }}
                </td>
                {% endfor %}
                <td class="total-amount-cell">
                    {% set total = totals | sum %}
                    {% if category_type != CategoryType.INCOME %}
                    {{ -total | round(2) | format_number }}
                    {% else %}
                    {{ total | round(2) | format_number }}
                    {% endif %}
                    {{ currency }}
                </td>
            </tr>
            {% endfor %}
            {% endfor %}

            <tr class="row-separator">
                <td colspan="15" class="current-balance-cell">ðŸ’¸ Current balance: {{ current_balance | round(2) |
                    format_number}} {{ currency }}</td>
            </tr>

            <tr class="total-by-month-row">
                <td colspan="2" class="category-cell">Total</td>
                {% for value in monthly_balance %}
                <td class="amount-cell">{{ value | round(2) | format_number }} {{ currency }}</td>
                {% endfor %}
                <td class="total-amount-cell">{{ monthly_balance | sum | round(2) | format_number }} {{ currency }}</td>
            </tr>

            <tr class="row-separator">
                <td colspan="15"><canvas id="regionBar" style="width: 100%; height: 20px;"></canvas></td>
            </tr>

            {% for category_type, totals in monthly_balance_per_category_type.items() %}
            <tr class="category-row {{ category_type.value }}">
                <td colspan="2" class="category-cell"
                    rowspan="{% if category_type != CategoryType.INCOME %}2{% else %}1{% endif %}">{{
                    category_type.value }}</td>
                {% for val in totals %}
                <td class="amount-cell">{{ val | round(2) | format_number }} {{ currency }}</td>
                {% endfor %}
                <td class="total-amount-cell">{{ totals | sum | round(2) | format_number }} {{ currency }}</td>
            </tr>

            {% if category_type != CategoryType.INCOME %}
            <tr class="category-row {{ category_type.value }}">
                {% for i in range(12) %}
                <td class="amount-prcnt-cell">
                    {% set income = monthly_balance_per_category_type[CategoryType.INCOME][i] %}
                    {% set expense = totals[i] | abs %}
                    {% if income > 0 %}
                    {{ (expense / income * 100) | round(1) | format_number }} %
                    {% else %}
                    0 %
                    {% endif %}
                </td>
                {% endfor %}
                <td class="total-amount-prcnt-cell">
                    {% set income_total = monthly_balance_per_category_type[CategoryType.INCOME] | sum %}
                    {% set exp_total = totals | sum | abs %}
                    {% if income_total > 0 %}
                    {{ (exp_total / income_total * 100) | round(1) | format_number }} %
                    <script>
                        year_expenses["{{ category_type.value }}"] = {{ (exp_total / income_total * 100) | round(0) }};
                    </script>
                    {% else %}
                    0 %
                    {% endif %}
                </td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>

<script src="{{ url_for('static', filename='bar_graph.js') }}"></script>

{% endblock %}