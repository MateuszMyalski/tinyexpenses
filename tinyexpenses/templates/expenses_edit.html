{% extends "index.html" %}

{% block content %}
<div class="table-wrapper">
    <form method="POST" class="csv-edit-form">
        <table id="csv-edit-table">
            <thead>
                <tr>
                    <th style="background-color: transparent; border:none"></th>
                    <th>Row</th>
                    <th>Timestamp</th>
                    <th>Category</th>
                    <th>Expense date</th>
                    <th>Amount</th>
                    <th>Description</th>
                    <th style="background-color: transparent; border:none"></th>
                </tr>
            </thead>
            <tbody>
                {% for row in expenses %}
                <tr class="source">
                    <td class="button"><input type="button" value="➖" onclick="deleteRow(this)" /></td>
                    <td>{{ loop.index }}</td>
                    <td class="data">{{ row.timestamp }}</td>
                    <td class="data" contenteditable="true">{{ row.category }}</td>
                    <td class="data" contenteditable="true">{{ row.date }}</td>
                    <td class="data" contenteditable="true">{{ row.amount }}</td>
                    <td class="data" contenteditable="true">{{ row.description }}</td>
                    <td class="button"><input type="button" value="➕" onclick="insRow(this)" /></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {{ form.hidden_tag() }}
        {{ form.table_data() }}
        {{ form.submit() }}
    </form>
</div>

<script>
    let diff = {
        addedRows: 0,
        removedRows: 0,
        modifiedCells: 0,
        prevTableData: ""
    };

    function deleteRow(button) {
        diff.modifiedCells += getCountOfModifiedCells();

        const row = button.closest("tr");
        row.remove();
        updateRowNumbers();

        diff.prevTableData = getTableData();

        if (row.className == "source") {
            diff.removedRows += 1;
        } else {
            diff.addedRows -= 1;
        }
    }

    function getCurrentTimestamp() {
        const now = new Date();

        const pad = (n) => String(n).padStart(2, '0');

        const year = now.getFullYear();
        const month = pad(now.getMonth() + 1);
        const day = pad(now.getDate());
        const hours = pad(now.getHours());
        const minutes = pad(now.getMinutes());
        const seconds = pad(now.getSeconds());

        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    function insRow(button) {
        diff.modifiedCells += getCountOfModifiedCells();

        const currentRow = button.closest("tr");
        const newRow = currentRow.cloneNode(true);

        newRow.className = "";
        // Clear all cell content except buttons
        const cells = newRow.querySelectorAll("td");
        for (let i = 3; i < cells.length - 1; i++) {
            cells[i].innerText = "";
        }

        cells[2].innerText = getCurrentTimestamp();

        currentRow.parentNode.insertBefore(newRow, currentRow.nextSibling);
        updateRowNumbers();

        diff.prevTableData = getTableData();

        diff.addedRows += 1;
    }

    function updateRowNumbers() {
        const table = document.getElementById("csv-edit-table");
        const rows = table.querySelectorAll("tbody tr");
        rows.forEach((row, index) => {
            row.cells[1].innerText = index + 1;
        });
    }

    function getTableData() {
        const rows = document.querySelectorAll("#csv-edit-table tbody tr");
        return Array.from(rows).map(row =>
            Array.from(row.querySelectorAll("td")).map(td => td.textContent.trim())
        );
    }

    function getCountOfModifiedCells() {
        const current = getTableData();
        const original = diff.prevTableData;
        let modifiedCells = 0;
        const minLen = Math.min(original.length, current.length);

        for (let i = 0; i < minLen; i++) {
            const origRow = original[i];
            const currRow = current[i];
            for (let j = 0; j < origRow.length; j++) {
                if ((origRow[j] || '') !== (currRow[j] || '')) {
                    modifiedCells++;
                }
            }
        }

        return modifiedCells
    }

    // Save original data when page loads
    window.addEventListener("DOMContentLoaded", () => {
        diff.prevTableData = getTableData();
    });


    document.querySelector("form").addEventListener("submit", function () {
        diff.modifiedCells += getCountOfModifiedCells()

        const msg = `Edited cells: ${diff.modifiedCells}\nNew rows ${diff.addedRows}\nRemoved rows ${diff.removedRows}\n\nProceed with saving changes?`;
        if (!confirm(msg)) {
            event.preventDefault();
            return false;
        }

        const rows = document.querySelectorAll("#csv-edit-table tbody tr");
        const tableData = Array.from(rows).map(row => {
            const tds = [...row.querySelectorAll("td.data")];
            return tds.map(td => td.textContent.trim());
        });
        document.querySelector("[name=table_data]").value = JSON.stringify(tableData);
    });

</script>

{% endblock %}