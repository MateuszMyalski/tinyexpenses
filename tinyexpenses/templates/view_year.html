{% extends "index.html" %}
{% block content %}
<script>
    year_expenses = {}
</script>
<div class="table-container">
    <table border="1" id="expenses-table">
        <thead>
            <tr>
                <th colspan="15" class="time-span-header">
                    <select id="year-select" onchange="location = this.value;">
                        {% for available_year in available_years %}
                        <option value="{{ url_for('main.view_year', year=available_year) }}" {% if
                            available_year|int==year|int %}selected{% endif %}>
                            {{ available_year }}
                        </option>
                        {% endfor %}
                    </select>
                </th>
            </tr>
            <tr>
                <th class="category">Category</th>
                <th class="category-type">Type</th>
                {% for i in range(12) %}
                <th class="month"><a href="{{ url_for('main.view_month', year=year, month=(i + 1)) }}">{{ month_names[i]
                        }}</a></th>
                {% endfor %}
                <th class="total">Total</th>
            </tr>
        </thead>
        <tbody>
            {% for category_type, categories_by_type in expenses_monthly_totals_by_category_type.items() %}
            {% for category, totals in categories_by_type.items() %}
            <tr class="category-row {{ category_type.value }}">
                <td class="category">{{ category }}</td>
                <td class="category-type">{{ category_type.value[0] }}</td>
                {% for value in totals %}
                <td class="expense-cell">
                    {% if value and category_type != CategoryType.INCOME %}-{% endif %}{{ value | round(2) }} {{
                    currency }}
                </td>
                {% endfor %}
                <td class="total-cell">
                    {% set total = totals | sum %}
                    {% if total and category_type != CategoryType.INCOME %}-{% endif %}{{ total | round(2) }} {{
                    currency }}
                </td>
            </tr>
            {% endfor %}
            {% endfor %}

            <tr class="row-separator">
                <td colspan="15" class="current-balance">ðŸ’¸ Current balance: {{ current_balance | round(2) |
                    format_number}} {{ currency }}</td>
            </tr>

            <tr class="total-by-month-row">
                <td colspan="2" class="total-cell">Total</td>
                {% for value in monthly_balance %}
                <td class="total-cell">{{ value | round(2) | format_number }} {{ currency }}</td>
                {% endfor %}
                <td class="total-cell">{{ monthly_balance | sum | round(2) | format_number }} {{ currency }}</td>
            </tr>

            <tr class="row-separator">
                <td colspan="15"><canvas id="regionBar" style="width: 100%; height: 20px;"></canvas></td>
            </tr>

            {% for category_type, totals in monthly_balance_per_category_type.items() %}
            <tr class="category-row {{ category_type.value }}">
                <td colspan="2" rowspan="{% if category_type != CategoryType.INCOME %}2{% else %}1{% endif %}">{{
                    category_type.value }}</td>
                {% for val in totals %}
                <td>{{ val | round(2) | format_number }} {{ currency }}</td>
                {% endfor %}
                <td>{{ totals | sum | round(2) | format_number }} {{ currency }}</td>
            </tr>

            {% if category_type != CategoryType.INCOME %}
            <tr class="category-row {{ category_type.value }}">
                {% for i in range(12) %}
                <td>
                    {% set income = monthly_balance_per_category_type[CategoryType.INCOME][i] %}
                    {% set expense = totals[i] | abs %}
                    {% if income > 0 %}
                    {{ (expense / income * 100) | round(1) | format_number }} %
                    {% else %}
                    0 %
                    {% endif %}
                </td>
                {% endfor %}
                <td>
                    {% set income_total = monthly_balance_per_category_type[CategoryType.INCOME] | sum %}
                    {% set exp_total = totals | sum | abs %}
                    {% if income_total > 0 %}
                    {{ (exp_total / income_total * 100) | round(1) | format_number }} %
                    <script>
                        year_expenses["{{ category_type.value }}"] = {{ (exp_total / income_total * 100) | round(0) }};
                    </script>
                    {% else %}
                    0 %
                    {% endif %}
                </td>
            </tr>
            {% endif %}
            {% endfor %}

        </tbody>
    </table>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const barColors = {};
        Object.keys(year_expenses).forEach(type => {
            barColors[type] = getComputedStyle(document.querySelector("tr.category-row." + type)).backgroundColor;
        });

        const canvas = document.getElementById("regionBar");
        const ctx = canvas.getContext("2d");

        // Ensure canvas scales with device pixel ratio
        const width = canvas.offsetWidth;
        const height = canvas.offsetHeight;
        canvas.width = width;
        canvas.height = height;

        const total = Object.values(year_expenses).reduce((sum, val) => sum + val, 0);

        Object.keys(year_expenses).forEach(key => {
            year_expenses[key] = year_expenses[key] / total;
        });

        const used = Object.values(year_expenses).reduce((sum, val) => sum + val, 0);
        year_expenses["Other"] = 1 - used;


        const regions = [
            { name: "Needs", color: barColors["Needs"], portion: year_expenses["Needs"] },
            { name: "Wants", color: barColors["Wants"], portion: year_expenses["Wants"] },
            { name: "Savings", color: barColors["Savings"], portion: year_expenses["Savings"] },
            { name: "Other", color: "gray", portion: year_expenses["Other"] },
        ];

        let x = 0;
        regions.forEach(region => {
            const regionWidth = width * region.portion;
            ctx.fillStyle = region.color;
            ctx.fillRect(x, 0, regionWidth, height);

            ctx.font = "bold 16px Arial";
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = 'black'


            if (region.portion >= 0.05) {
                ctx.fillText(Math.round(year_expenses[region.name] * 100, 1) + " %", x + regionWidth / 2, canvas.height / 2 + 2);
            }

            x += regionWidth;
        });
    });
</script>

{% endblock %}